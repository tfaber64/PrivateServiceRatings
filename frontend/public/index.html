<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin"/>
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Private Service Ratings · Zama FHE</title>
  <style>
    :root{
      --bg:#f7fafc;--panel:#ffffff;--ink:#0f172a;--muted:#6b7280;--acc:#2563eb;--ok:#10b981;--err:#ef4444;
      --bd:#e5e7eb;--shadow:0 12px 40px rgba(15,23,42,.06);--r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(70vw 70vw at -10% -10%, #dbeafe 0%, transparent 55%),
      radial-gradient(80vw 80vw at 120% 0%, #bbf7d0 0%, transparent 55%),
      var(--bg);color:var(--ink);font:15px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:10px;background:conic-gradient(from 180deg,#c7d2fe,#bbf7d0,#c7d2fe);display:grid;place-items:center;font-weight:900}
    .chip{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff;color:#334155}
    .you{margin-left:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    h2{margin:0 0 10px;font-size:18px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    input[type="text"]{width:100%;padding:12px;border:1px solid var(--bd);border-radius:12px;background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stars{display:flex;gap:6px}
    .star{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--bd);cursor:pointer;background:#fff}
    .star.sel{background:#fde68a;border-color:#f59e0b}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:800;background:#111827;color:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8)}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:#111827}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input{min-width:280px}
    .status{margin-top:8px;color:var(--muted)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--bd);border-radius:10px;padding:8px 10px;background:#fff}
    .handles{font-size:12px;border:1px dashed #cbd5e1;border-radius:12px;padding:10px;background:#fafcff}
    footer{margin:16px 0;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <div class="brand">
        <div class="logo">★</div>
        <div>
          <h1 style="margin:0;font-size:20px">Private Service Ratings</h1>
          <div class="muted" style="font-size:12px">Aggregates only • Fully Homomorphic (Zama FHEVM)</div>
        </div>
      </div>
      <span id="net" class="chip">Network: —</span>
      <span id="ctr" class="chip">Contract: —</span>
      <span id="owner" class="chip">Owner: —</span>
      <span id="me" class="chip you">—</span>
    </header>

    <section class="grid">
      <!-- Left: user -->
      <article class="card">
        <h2>Submit Private Rating</h2>
        <p class="muted" style="margin-top:-6px">Your rating is encrypted; only per-service <b>sum</b> and <b>count</b> are kept encrypted on-chain.</p>

        <div class="row">
          <div class="input" style="flex:1">
            <label>Service key (any text)</label>
            <input id="svcKey" type="text" placeholder="e.g. cafe-venue-42"/>
            <div class="muted mono" style="margin-top:6px;font-size:12px">
              ID: <span id="svcId">—</span>
            </div>
          </div>

          <div>
            <label>Rating (1..5)</label>
            <div class="stars" id="stars"></div>
            <div class="muted" style="font-size:12px">selected: <span id="sel">3</span></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnSubmit" class="btn primary">Submit Encrypted Rating</button>
          <button id="btnCheckRated" class="btn ghost">Check “Rated?”</button>
        </div>

        <div id="uStatus" class="status"></div>
        <div id="txbox" class="status mono">tx: –</div>

        <div style="margin-top:16px">
          <h3 style="margin:0 0 6px;font-size:14px">Aggregates (sum / count)</h3>
          <div class="row">
            <span class="pill mono">sum <span id="sum">—</span></span>
            <span class="pill mono">count <span id="count">—</span></span>
          </div>
          <div class="muted" style="margin-top:6px;font-size:12px">
            If the owner made aggregates public, we'll use <span class="mono">publicDecrypt</span>.
            Otherwise we'll request a signature and run <span class="mono">userDecrypt</span>.
          </div>
        </div>
      </article>

      <!-- Right: admin -->
      <article class="card">
        <h2>Admin Tools</h2>
        <p class="muted" style="margin-top:-6px">Initialize a service and optionally mark its aggregates <b>publicly decryptable</b>.</p>

        <div class="row">
          <div class="input" style="flex:1">
            <label>Service key</label>
            <input id="svcAdm" type="text" placeholder="abc"/>
            <div class="muted mono" style="margin-top:6px;font-size:12px">ID: <span id="admId">—</span></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnInit" class="btn ghost">Init/Reset Service</button>
          <button id="btnPublic" class="btn primary">Make Aggregates Public</button>
        </div>

        <div id="aStatus" class="status"></div>

        <div style="margin-top:14px">
          <label>Handles (for audit)</label>
          <div class="handles mono">
            sum: <span id="hSum">—</span><br/>
            count: <span id="hCount">—</span>
          </div>
        </div>
      </article>
    </section>

    <footer>
      Relayer: v0.2.0 · ethers v6 · Contract: <span class="mono" id="ctrFoot"></span>
    </footer>
  </main>

  <!-- SDKs -->
  <script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>
  <script type="module">
    import { BrowserProvider, Contract, getAddress, keccak256, toUtf8Bytes } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
    import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

    // ===== Config =====
    const CHAIN_ID = 11155111n; // Sepolia
    const CONTRACT_ADDRESS = "0xd6474eB16518890734BA294fCA5a8533Dc0DA8Ff";
    const RELAYER_URL = "https://relayer.testnet.zama.cloud";

    const ABI = [
      { inputs: [], name: "version", stateMutability: "pure", type: "function", outputs: [{type:"string"}]},
      { inputs: [], name: "owner",  stateMutability: "view", type: "function", outputs:[{type:"address"}]},
      { inputs: [{name:"serviceId", type:"bytes32"}], name: "initService", stateMutability: "nonpayable", type:"function", outputs:[] },
      { inputs: [{name:"serviceId", type:"bytes32"}], name: "makeAggregatesPublic", stateMutability: "nonpayable", type:"function", outputs:[] },
      { inputs: [{name:"serviceId", type:"bytes32"}], name: "getAggregateHandles", stateMutability: "view", type:"function", outputs:[{name:"sumH",type:"bytes32"},{name:"countH",type:"bytes32"}]},
      { inputs: [{name:"serviceId", type:"bytes32"}, {name:"ratingExt", type:"bytes32"}, {name:"proof", type:"bytes"}], name:"submitRating", stateMutability:"nonpayable", type:"function", outputs:[] },
      { inputs: [{name:"serviceId", type:"bytes32"}, {name:"user", type:"address"}], name: "hasRated", stateMutability: "view", type:"function", outputs:[{type:"bool"}] }
    ];

    // ===== Mini logger =====
    let step=0;
    const log = (...a)=>console.log(`[PSR ${++step}]`, ...a);
    const warn= (...a)=>console.warn(`[PSR ${++step}]`, ...a);
    const err = (...a)=>console.error(`[PSR ${++step}]`, ...a);

    // ===== DOM =====
    const $ = (id)=>document.getElementById(id);
    const els = {
      net: $("net"), ctr:$("ctr"), ctrFoot:$("ctrFoot"), me:$("me"), owner:$("owner"),
      svcKey:$("svcKey"), svcId:$("svcId"), sel:$("sel"), btnSubmit:$("btnSubmit"), btnCheckRated:$("btnCheckRated"), sum:$("sum"), count:$("count"), txbox:$("txbox"), uStatus:$("uStatus"), stars:$("stars"),
      svcAdm:$("svcAdm"), admId:$("admId"), btnInit:$("btnInit"), btnPublic:$("btnPublic"), aStatus:$("aStatus"), hSum:$("hSum"), hCount:$("hCount")
    };
    const short = (a)=>a? a.slice(0,6)+"…"+a.slice(-4) : "—";
    const sid = (k)=>keccak256(toUtf8Bytes((k||"").trim()));

    // ===== UI: stars =====
    let rating = 3;
    function renderStars(){
      els.stars.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b=document.createElement("button");
        b.className="star"+(i<=rating?" sel":"");
        b.textContent="★";
        b.onclick=()=>{ rating=i; els.sel.textContent=String(rating); renderStars(); };
        els.stars.appendChild(b);
      }
    }
    renderStars();

    function reflectIds(){
      els.svcId.textContent = sid(els.svcKey.value);
      els.admId.textContent = sid(els.svcAdm.value);
    }
    ["input","change"].forEach(ev=>{
      els.svcKey.addEventListener(ev, reflectIds);
      els.svcAdm.addEventListener(ev, reflectIds);
    });
    els.svcKey.value = "cafe-venue-42";
    els.svcAdm.value = "cafe-venue-42";
    reflectIds();

    // ===== State =====
    let provider, signer, user, contract, relayer, owner;

    function explain(e){
      return e?.shortMessage || e?.reason || e?.error?.message || e?.message || "execution reverted";
    }

    // ===== Bootstrap =====
    async function connect(){
      if(!window.ethereum) throw new Error("Install MetaMask");
      provider = new BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts",[]);
      const net = await provider.getNetwork();
      log("network", net.chainId.toString());
      if(net.chainId !== CHAIN_ID){
        log("switching to Sepolia…");
        await provider.send("wallet_switchEthereumChain", [{ chainId: "0xaa36a7" }]);
      }
      signer = await provider.getSigner();
      user = await signer.getAddress();
      contract = new Contract(getAddress(CONTRACT_ADDRESS), ABI, signer);

      els.net.textContent = "Network: Sepolia";
      els.ctr.textContent = "Contract: "+short(CONTRACT_ADDRESS);
      els.ctrFoot.textContent = CONTRACT_ADDRESS;
      els.me.textContent = short(user);

      try{
        owner = await contract.owner();
        els.owner.textContent = "Owner: "+short(owner) + (owner.toLowerCase()===user.toLowerCase()?" (you)":" (not you)");
        log("owner", owner);
      }catch(e){ warn("owner read failed", e); }

      await initSDK();
      relayer = await createInstance({ ...SepoliaConfig, network: window.ethereum, relayerUrl: "https://relayer.testnet.zama.cloud", debug: true });
      log("relayer ready", relayer? "ok":"fail");
    }
    await connect();

    // ===== Encryption helper =====
    async function encrypt32For(addr, ua, value){
      const buf = relayer.createEncryptedInput(getAddress(addr), getAddress(ua));
      buf.add32(BigInt(value));
      const { handles, inputProof } = await buf.encrypt();
      log("encrypt32", { handle: String(handles?.[0]||"0x"), proofBytes: inputProof?.length||0 });
      if(!handles?.length) throw new Error("no handle");
      return { handle: handles[0], proof: inputProof };
    }

    // ===== Read aggregates (safe) =====
    async function readAggregatesSafe(serviceId){
      els.hSum.textContent = "—"; els.hCount.textContent = "—";
      els.sum.textContent = "—"; els.count.textContent = "—";
      try{
        const [sumH, countH] = await contract.getAggregateHandles(serviceId);
        els.hSum.textContent = sumH;
        els.hCount.textContent = countH;
        // publicDecrypt first
        try{
          const out = await relayer.publicDecrypt([sumH, countH]);
          const s = Array.isArray(out)? BigInt(out[0]||0) : BigInt(out[sumH]||0);
          const c = Array.isArray(out)? BigInt(out[1]||0) : BigInt(out[countH]||0);
          els.sum.textContent = s.toString();
          els.count.textContent = c.toString();
          log("publicDecrypt", { s: String(s), c: String(c) });
        }catch(e){
          warn("publicDecrypt failed -> userDecrypt", e?.message||e);
          const kp = await generateKeypair();
          const startTs = Math.floor(Date.now()/1000).toString();
          const days = "7";
          const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
          const sig = await signer.signTypedData(eip.domain, { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification }, eip.message);
          const pairs = [{handle:sumH,contractAddress:CONTRACT_ADDRESS},{handle:countH,contractAddress:CONTRACT_ADDRESS}];
          const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig.replace("0x",""), [CONTRACT_ADDRESS], user, startTs, days);
          const s = BigInt(out[sumH] ?? out[Object.keys(out).find(k=>k.toLowerCase()===sumH.toLowerCase())] ?? 0);
          const c = BigInt(out[countH] ?? out[Object.keys(out).find(k=>k.toLowerCase()===countH.toLowerCase())] ?? 0);
          els.sum.textContent = s.toString();
          els.count.textContent = c.toString();
          log("userDecrypt", { s: String(s), c: String(c) });
        }
      }catch(e){
        els.uStatus.innerHTML = `<span class="err">Failed to read aggregates. Ensure the service exists.</span>`;
        warn("getAggregateHandles failed", explain(e));
      }
    }

    // ===== Actions =====
    // submit
    $("btnSubmit").onclick = async ()=>{
      try{
        const key = els.svcKey.value.trim();
        if(!key) throw new Error("Enter service key");
        const serviceId = sid(key);
        els.uStatus.textContent = "Encrypting…";
        const { handle, proof } = await encrypt32For(CONTRACT_ADDRESS, user, rating);
        els.uStatus.textContent = "Sending tx…";
        let tx;
        try{
          tx = await contract.submitRating(serviceId, handle, proof, { gasLimit: 1_500_000 });
        }catch(e1){
          warn("submitRating send failed (retry without explicit gas)", explain(e1));
          tx = await contract.submitRating(serviceId, handle, proof);
        }
        els.txbox.textContent = "tx: " + tx.hash;
        log("tx sent", tx.hash);
        await tx.wait();
        els.uStatus.innerHTML = `<span class="ok">Submitted ✔</span>`;
        await readAggregatesSafe(serviceId);
      }catch(e){
        els.uStatus.innerHTML = `<span class="err">${explain(e)}</span>`;
        err("submit error", e);
      }
    };

    // rated?
    $("btnCheckRated").onclick = async ()=>{
      try{
        const key = els.svcKey.value.trim();
        if(!key) throw new Error("Enter service key");
        const serviceId = sid(key);
        const out = await contract.hasRated(serviceId, user);
        els.uStatus.innerHTML = out ? `<span class="ok">Already rated</span>` : `<span>Not rated yet</span>`;
        log("hasRated", out);
      }catch(e){ els.uStatus.innerHTML = `<span class="err">${explain(e)}</span>`; }
    };

    // init
    $("btnInit").onclick = async ()=>{
      try{
        const key = els.svcAdm.value.trim();
        if(!key) throw new Error("Enter service key");
        const serviceId = sid(key);
        els.aStatus.textContent = "Sending init/reset…";
        let tx;
        try{
          tx = await contract.initService(serviceId, { gasLimit: 1_200_000 });
        }catch(e1){
          warn("initService send failed (retry without explicit gas)", explain(e1));
          tx = await contract.initService(serviceId);
        }
        els.aStatus.textContent = "tx: " + tx.hash;
        log("init tx", tx.hash);
        const rcpt = await tx.wait();
        log("init mined", rcpt.blockNumber);
        els.aStatus.innerHTML = `<span class="ok">Service initialized.</span>`;
        await readAggregatesSafe(serviceId);
      }catch(e){
        els.aStatus.innerHTML = `<span class="err">${explain(e)}</span>`;
        err("init error", e);
      }
    };

    // make public
    $("btnPublic").onclick = async ()=>{
      try{
        const key = els.svcAdm.value.trim();
        if(!key) throw new Error("Enter service key");
        const serviceId = sid(key);
        els.aStatus.textContent = "Sending make-public…";
        let tx;
        try{
          tx = await contract.makeAggregatesPublic(serviceId, { gasLimit: 1_000_000 });
        }catch(e1){
          warn("makeAggregatesPublic send failed (retry without explicit gas)", explain(e1));
          tx = await contract.makeAggregatesPublic(serviceId);
        }
        els.aStatus.textContent = "tx: " + tx.hash;
        const rcpt = await tx.wait();
        log("makePublic mined", rcpt.blockNumber);
        els.aStatus.innerHTML = `<span class="ok">Aggregates are publicly decryptable.</span>`;
        await readAggregatesSafe(serviceId);
      }catch(e){
        els.aStatus.innerHTML = `<span class="err">${explain(e)}</span>`;
        err("make-public error", e);
      }
    };

    // first paint: try safe read (will show hint if not exists)
    await readAggregatesSafe(sid(els.svcKey.value));
  </script>
</body>
</html>
